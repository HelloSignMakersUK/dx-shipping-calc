<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DX Shipping Calculator</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .parcel-group { margin-bottom: 10px; }
    .parcel-group input { width: 80px; margin-right: 5px; }
    #result { white-space: pre-wrap; margin-top: 20px; }
    .error { color: red; }
    textarea { width: 100%; height: 120px; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>DX Shipping Calculator</h2>

  <div id="parcels"></div>
  <button id="addParcelBtn">Add Parcel</button>

  <div>
    <label>Destination Postcode: <input id="postcode" required></label><br><br>
    <label>Fuel Surcharge (%): <input id="fuel" type="number" value="13.95" required></label><br><br>

    <fieldset>
      <legend>Additional Options</legend>
      <label><input type="checkbox" class="extra" value="Residential Delivery|10.90"> Residential Delivery (+£10.90)</label><br>
      <label><input type="checkbox" class="extra" value="Pre-Noon Delivery|15.70"> Pre-Noon Delivery (+£15.70)</label><br>
      <label><input type="checkbox" class="extra" value="Pre-9:30am Delivery|39.00"> Pre-9:30am Delivery (+£39.00)</label><br>
      <label><input type="checkbox" class="extra" value="Saturday Delivery|32.00"> Saturday Delivery (+£32.00)</label><br>
      <label><input type="checkbox" class="extra" value="Saturday Pre-9:30am Delivery|50.00"> Saturday Pre-9:30am Delivery (+£50.00)</label><br>
      <label><input type="checkbox" class="extra" value="Increased Insurance|20.00"> Insurance Upgrade to £5,000 (+£20.00)</label>
    </fieldset>

    <br>
    <label>Courier Email: <input id="email" value="Jackie.Kingman@dxdelivery.com; Nick.Scott@dxdelivery.com; Tasha.Joyce@dxdelivery.com; Brendon.Bridge@dxdelivery.com; Richard.Flambard@dxdelivery.com; Depot18@dxdelivery.com"></label><br><br>
    <label>CC: <input id="cc" value="hello@signmakersuk.com"></label><br><br>

    <button id="calculateShippingBtn">Calculate Shipping</button>
    <button id="sendEmailBtn">Send Collection Request</button>
    <p class="error" id="error"></p>
  </div>

  <div id="result"></div>

  <h3>Instructions</h3>
  <textarea id="instructions" placeholder="Enter instructions here..."></textarea>

  <script>
    window.addParcel = function addParcel() {
      const parcelContainer = document.getElementById('parcels');
      const parcelDiv = document.createElement('div');
      parcelDiv.className = 'parcel-group';
      parcelDiv.innerHTML = `
        <label></label>
        Weight (kg): <input type="number" class="weight" step="0.01" required>
        Length (cm): <input type="number" class="length" step="0.1" required>
        Width (cm): <input type="number" class="width" step="0.1" required>
        Height (cm): <input type="number" class="height" step="0.1" required>
        <button onclick="removeParcel(this)">Remove</button>
      `;
      parcelContainer.appendChild(parcelDiv);
      renumberParcels();
    }

    function removeParcel(button) {
      button.parentElement.remove();
      renumberParcels();
    }

    function renumberParcels() {
      const parcelGroups = document.querySelectorAll('.parcel-group');
      parcelGroups.forEach((group, index) => {
        const label = group.querySelector('label');
        label.textContent = `Parcel ${index + 1}`;
      });
    }

    function calculateShipping() {
      const weights = [...document.querySelectorAll('.weight')].map(i => parseFloat(i.value) || 0);
      const lengths = [...document.querySelectorAll('.length')].map(i => parseFloat(i.value) || 0);
      const widths = [...document.querySelectorAll('.width')].map(i => parseFloat(i.value) || 0);
      const heights = [...document.querySelectorAll('.height')].map(i => parseFloat(i.value) || 0);
      const postcode = document.getElementById('postcode').value.trim();
      const fuelSurcharge = parseFloat(document.getElementById('fuel').value) || 0;

      const extras = [...document.querySelectorAll('.extra:checked')]
        .map(x => x.value.split('|'))
        .map(([desc, val]) => ({ desc, cost: parseFloat(val) }));

      if (!postcode || weights.includes(0) || lengths.includes(0) || widths.includes(0) || heights.includes(0)) {
        document.getElementById('error').textContent = 'Please complete all parcel dimensions and postcode.';
        document.getElementById('result').textContent = '';
        return;
      }
      document.getElementById('error').textContent = '';

      let totalCost = 0;
      let totalWeight = 0;
      const baseRate = 10.00;
      const geoSurcharge = postcode.startsWith('BT') ? 7.20 : 0;

      let parcelBreakdown = '';

      for (let i = 0; i < weights.length; i++) {
        const deadWeight = weights[i];
        const volWeight = (lengths[i] * widths[i] * heights[i]) / 5000;
        const billableWeight = Math.max(deadWeight, volWeight);
        totalWeight += billableWeight;
        parcelBreakdown += `Parcel ${i + 1}: ${deadWeight}kg, ${lengths[i]}x${widths[i]}x${heights[i]}cm\n`;
      }

      if (totalWeight <= 20) {
        totalCost = baseRate + geoSurcharge;
      } else {
        totalCost = (totalWeight * 0.55) + geoSurcharge;
      }

      const extrasTotal = extras.reduce((sum, x) => sum + x.cost, 0);
      const fuelCharge = totalCost * (fuelSurcharge / 100);
      const totalWithFuel = totalCost + fuelCharge + extrasTotal;
      const vat = totalWithFuel * 0.2;
      const totalWithVat = totalWithFuel + vat;

      const region = geoSurcharge > 0 ? `Northern Ireland (+£${geoSurcharge.toFixed(2)})` : 'UK Mainland';

      const extrasBreakdown = extras.map(x => `+ £${x.cost.toFixed(2)} ${x.desc}`).join('\n');

      document.getElementById('result').innerHTML = 
        `Region: ${region}\n` +
        `${parcelBreakdown}` +
        `Base + Weight Cost: £${totalCost.toFixed(2)}\n` +
        `Fuel Surcharge: £${fuelCharge.toFixed(2)}\n` +
        `${extrasBreakdown ? 'Extras:\n' + extrasBreakdown + '\n' : ''}` +
        `Total (ex VAT): £${totalWithFuel.toFixed(2)}\n` +
        `Total (inc VAT): £${totalWithVat.toFixed(2)}`;
    }

    window.onload = () => {
      const defaultInstructions = `STEP 1: Measure and weigh each parcel and fill out the details above.
STEP 2: Fuel surcharge can be found on DX paperwork (currently 13.95% as of 20/06/2025).
STEP 3: Log in to https://dm6.dxfreight.co.uk/logon/logon.aspx using:
  Depot: 95
  Account No.: 93022848
  Password: b25i3c
STEP 4: Use Dispatch Manager 6 Light and follow consignment entry instructions.
STEP 5: Produce a consignment for each parcel/destination.
STEP 6: Once all parcels are entered, print 2 copies of the manifest for the driver.
SAME DAY COLLECTION: Submit before 11am. Collection is between 2–3pm.`;

      if (!localStorage.getItem('dxInstructions')) {
        localStorage.setItem('dxInstructions', defaultInstructions);
      }
      const storedInstructions = localStorage.getItem('dxInstructions');
      document.getElementById('instructions').value = storedInstructions;
      document.getElementById('instructions').addEventListener('change', function () {
        localStorage.setItem('dxInstructions', this.value);
      });

      document.getElementById('addParcelBtn').addEventListener('click', window.addParcel);
      document.getElementById('calculateShippingBtn').addEventListener('click', calculateShipping);

      window.addParcel();
    }
  </script>
</body>
</html>
